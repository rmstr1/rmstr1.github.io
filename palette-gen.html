<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./css/fonts.css">
    <link rel="stylesheet" href="./style-editor-simple.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Palette Generator">
    <title>Palette Generator</title>
</head>

<body>
    <div class="container">
        <h1>Pallette Generator</h1>
        <span>
            Colors (sRGB):
            <div class="group">
                <input id="a_color" type="color" value="#f361e4" autocomplete="off">
                <input id="a_text" type="text" value="#f361e4" maxlentgh="7" size="8" spellcheck="false"
                    autocomplete="off">
            </div>
            <div class="group">
                <input id="b_color" type="color" value="#bee0db" autocomplete="off">
                <input id="b_text" type="text" value="#bee0db" maxlentgh="7" size="8" spellcheck="false"
                    autocomplete="off">
            </div>
        </span>
        <label>Interpolation Colorspace:
            <select id="interpolation" autocomplete="off">
                <option value="oklab">okLab</option>
                <option value="linear">linear sRGB</option>
                <option value="srgb">sRGB</option>
            </select>
        </label>
        <label>Interpolation Curvature:
            <div class="group">
                <input id="t_slider" type="range" min="-1.0" max="1.0" value="0.0" step=0.01 autocomplete="off">
                <input id="t_number" type="number" min="-1.0" max="1.0" value="0.0" size="5" step=0.01
                    autocomplete="off">
            </div>
        </label>
        <label>Palette Size:
            <input id="n_bands" type="number" min="2" max="256" value="5" size="3" autocomplete="off">
        </label>
        <div>TODO: Add Curvature param</div>
        <hr>
        Palette:
        <div id="output">
        </div>
    </div>
</body>
<script>
    const lerp_scalar = (a, b, t) => a * (1.0 - t) + b * t;

    const lerp = (a, b, t) => {
        return a.map((x, i) => {
            return lerp_scalar(x, b[i], t);
        });
    }

    function clamp(x, lower, upper) {
        return Math.min(Math.max(x, lower), upper);
    }

    /// y value of circle segment between x= -1, 1, with y=h at x = 0, evaluated at x.
    /// assumes -1.0 <= x <= 1.0
    function getArcY(x, h) {
        if (Math.abs(h) < 1e-12) return 0;
        const curvature = (2 * h) / (h * h + 1);
        const radicand = 1 - Math.pow(curvature * x, 2);
        return (h * (1 - x * x)) / (1 + Math.sqrt(Math.max(0, radicand)));
    }

    /// interpolated point with interpolation param t: [0.0, 1.0] along circular arc from [-1, 0] to [1, 0], with sagitta(bulge) h.
    /// TODO: use this.
    function interpolateArc(t, h) {
        const u = 2 * t - 1;
        const denom = 1 + h * h * u * u;
        return [u * (1 + h * h) / denom, (h * (1 - u * u)) / denom];
    }

    const srgbToLinear = (srgb) => {
        return srgb.map((x) => {
            const cutoff = x > 0.04045;
            const a = x / 12.92;
            const b = ((x + 0.055) / 1.055) ** 2.4;
            return cutoff ? b : a;
        });
    }

    const linearToSrgb = (linear) => {
        return linear.map((x) => {
            const cutoff = x > 0.0031308;
            const a = x * 12.92;
            const b = 1.055 * x ** (1.0 / 2.4) - 0.055;
            return cutoff ? b : a;
        });
    }

    const linearToOklab = (c) => {
        const [r, g, b] = c;

        const l = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;
        const m = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;
        const s = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;

        const l_ = l ** (1.0 / 3.0);
        const m_ = m ** (1.0 / 3.0);
        const s_ = s ** (1.0 / 3.0);

        return [
            0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_,
            1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_,
            0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_
        ];
    }

    const oklabToLinear = (c) => {
        const [x, y, z] = c;

        const l_ = x + 0.3963377774 * y + 0.2158037573 * z;
        const m_ = x - 0.1055613458 * y - 0.0638541728 * z;
        const s_ = x - 0.0894841775 * y - 1.2914855480 * z;

        const l = l_ * l_ * l_;
        const m = m_ * m_ * m_;
        const s = s_ * s_ * s_;

        return [
            +4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s,
            -1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s,
            -0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s
        ];
    }

    srgbToOklab = (c) => linearToOklab(srgbToLinear(c));

    oklabToSrgb = (c) => linearToSrgb(oklabToLinear(c));

    const parseHex = (hex) => {
        const r = parseFloat(parseInt(hex.slice(1, 3), 16)) / 255.0;
        const g = parseFloat(parseInt(hex.slice(3, 5), 16)) / 255.0;
        const b = parseFloat(parseInt(hex.slice(5, 7), 16)) / 255.0;
        return [r, g, b];
    }

    const writeHex = (rgb) => {
        const [r, g, b] = rgb;
        const r_u = clamp(Math.round(r * 255.0), 0, 255);
        const g_u = clamp(Math.round(g * 255.0), 0, 255);
        const b_u = clamp(Math.round(b * 255.0), 0, 255);
        return "#" + (1 << 24 | r_u << 16 | g_u << 8 | b_u).toString(16).slice(1);
    }

    const updateOutput = () => {
        const interpolation = document.querySelector('#interpolation').value;

        const [to_ispace, from_ispace] = {
            "linear": [srgbToLinear, linearToSrgb],
            "srgb": [(x) => x, (x) => x],
            "oklab": [srgbToOklab, oklabToSrgb],
        }[interpolation];

        const a_ispace = to_ispace(parseHex(a_text.value));
        const b_ispace = to_ispace(parseHex(b_text.value));
        const normal_ispace = [-(b_ispace[2] - a_ispace[2]) / 2.0, (b_ispace[1] - a_ispace[1]) / 2.0]

        const palette_count = Number(n_bands.value);
        const curvature_t = Number(t_slider.value);

        output.replaceChildren();
        for (let i = 0; i < palette_count; i++) {
            const t = i / (palette_count - 1.0);

            const x = 2.0 * t - 1.0;
            const y = getArcY(x, curvature_t);

            let value_ispace = lerp(a_ispace, b_ispace, t)
            value_ispace[1] += normal_ispace[0] * y;
            value_ispace[2] += normal_ispace[1] * y;

            const hex_rgb = writeHex(from_ispace(value_ispace))

            output.insertAdjacentHTML("beforeend",
                `
                <div class="palette-group">
                    <input type="color" value="${hex_rgb}" autocomplete="off">
                    <input type="text" value="${hex_rgb}" maxlentgh="7" size="8" spellcheck="false" autocomplete="off">
                </div>
                `)
        }
    }

    const a_text = document.querySelector('#a_text');
    const a_color = document.querySelector('#a_color');
    const b_text = document.querySelector('#b_text');
    const b_color = document.querySelector('#b_color');
    const output = document.querySelector('#output');
    const n_bands = document.querySelector('#n_bands');
    const interpolation = document.querySelector('#interpolation');
    const t_slider = document.querySelector('#t_slider');
    const t_number = document.querySelector('#t_number');

    a_text.addEventListener('change', (e) => { a_color.value = e.target.value; updateOutput(); });
    b_text.addEventListener('change', (e) => { b_color.value = e.target.value; updateOutput(); });
    a_color.addEventListener('change', (e) => { a_text.value = e.target.value; updateOutput(); });
    b_color.addEventListener('change', (e) => { b_text.value = e.target.value; updateOutput(); });
    n_bands.addEventListener('change', (e) => updateOutput());
    interpolation.addEventListener('change', (e) => updateOutput());
    t_slider.addEventListener('input', (e) => { t_number.value = e.target.value; updateOutput() });
    t_number.addEventListener('change', (e) => { t_slider.value = e.target.value; updateOutput() });


    updateOutput();
</script>

</html>