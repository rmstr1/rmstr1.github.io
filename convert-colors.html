<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./css/fonts.css">
    <link rel="stylesheet" href="./style-editors-simple.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Color Converter">
    <title>Color Converter</title>
</head>

<body>
    <div class="container">
        <h1>Color Converter</h1>
        <input id="color-selector" type="color" value="#79dbcf" autocomplete="off">
        <hr>
        sRGB:<br>
        <input id="input-hex-srgb" type="text" value="#79dbcf" maxlentgh="7" size="9" spellcheck="false"
            autocomplete="off">
        <input id="input-vec-srgb" type="text" value="vec3(1.0000, 1.0000, 1.0000)" size="30" spellcheck="false"
            autocomplete="off">
        <hr>
        linear:<br>
        <input id="input-hex-linear" type="text" value="#79dbcf" maxlentgh="7" size="9" spellcheck="false"
            autocomplete="off">
        <input id="input-vec-linear" type="text" value="vec3(1.0000, 1.0000, 1.0000)" size="30" spellcheck="false"
            autocomplete="off">
        <hr>
        CMYK:<br>
        <input id="input-cmyk" type="text" value="[1.0, 1.0, 1.0, 0]" size="41" spellcheck="false" autocomplete="off">
    </div>
</body>
<script>
    const srgbToLinear = (srgb) => {
        return srgb.map((x) => {
            const cutoff = x > 0.04045;
            const a = x / 12.92;
            const b = ((x + 0.055) / 1.055) ** 2.4;
            return cutoff ? b : a;
        });
    }

    const linearToSrgb = (linear) => {
        return linear.map((x) => {
            const cutoff = x > 0.0031308;
            const a = x * 12.92;
            const b = 1.055 * x ** (1.0 / 2.4) - 0.055;
            return cutoff ? b : a;
        });
    }

    const cmykToLinear = (cmyk) => {
        const [c, m, y, k] = cmyk;
        const r = (1.0 - c) * (1.0 - k);
        const g = (1.0 - m) * (1.0 - k);
        const b = (1.0 - y) * (1.0 - k);
        return [r, g, b];
    }

    const linearToCmyk = (linear) => {
        const [r, g, b] = linear;
        const k = 1.0 - Math.max(r, g, b);
        const one_minus_k = (1.0 - k);
        if (one_minus_k <= 1e-9) {
            return [0, 0, 0, 0];
        } else {
            const c = (1.0 - r - k) / one_minus_k;
            const m = (1.0 - g - k) / one_minus_k;
            const y = (1.0 - b - k) / one_minus_k;
            return [c, m, y, k];
        }
    }

    const parseCmyk = (cmyk_string) => {
        return JSON.parse(cmyk_string) ?? [0, 0, 0, 0];
    }

    const writeCmyk = (cmyk) => {
        const [c, m, y, k] = cmyk;
        return `[${c.toFixed(2)}, ${m.toFixed(2)}, ${y.toFixed(2)}, ${k.toFixed(2)}]`;
    }

    const parseHex = (hex) => {
        const r = parseFloat(parseInt(hex.slice(1, 3), 16)) / 255.0;
        const g = parseFloat(parseInt(hex.slice(3, 5), 16)) / 255.0;
        const b = parseFloat(parseInt(hex.slice(5, 7), 16)) / 255.0;
        return [r, g, b];
    }

    const writeHex = (rgb) => {
        const [r, g, b] = rgb;
        const r_u = Math.round(r * 255.0);
        const g_u = Math.round(g * 255.0);
        const b_u = Math.round(b * 255.0);
        return "#" + (1 << 24 | r_u << 16 | g_u << 8 | b_u).toString(16).slice(1);
    }

    const writeVec = (rgb) => {
        const [r, g, b] = rgb;
        return `vec3(${r.toFixed(4)}, ${g.toFixed(4)}, ${b.toFixed(4)})`;
    }

    const parseVec = (vec_string) => {
        vec_string = vec_string.replace('vec3(', '[');
        vec_string = vec_string.replace(')', ']');
        return JSON.parse(vec_string) ?? [0, 0, 0];
    }

    const update_values_from_linear = (linear) => {
        color_selector.value = writeHex(linearToSrgb(linear));
        input_hex_srgb.value = writeHex(linearToSrgb(linear));
        input_vec_srgb.value = writeVec(linearToSrgb(linear));
        input_hex_linear.value = writeHex(linear);
        input_vec_linear.value = writeVec(linear);
        input_cmyk.value = writeCmyk(linearToCmyk(linear));
        preview.style.backgroundColor = writeHex(linearToSrgb(linear));
    }

    const preview = document.querySelector('body');
    const color_selector = document.querySelector('#color-selector');
    const input_hex_srgb = document.querySelector('#input-hex-srgb');
    const input_vec_srgb = document.querySelector('#input-vec-srgb');
    const input_hex_linear = document.querySelector('#input-hex-linear');
    const input_vec_linear = document.querySelector('#input-vec-linear');
    const input_cmyk = document.querySelector('#input-cmyk');

    color_selector.addEventListener('change', (e) => update_values_from_linear(srgbToLinear(parseHex(e.target.value))));
    input_hex_srgb.addEventListener('change', (e) => update_values_from_linear(srgbToLinear(parseHex(e.target.value))));
    input_vec_srgb.addEventListener('change', (e) => update_values_from_linear(srgbToLinear(parseVec(e.target.value))));
    input_hex_linear.addEventListener('change', (e) => update_values_from_linear(parseHex(e.target.value)));
    input_vec_linear.addEventListener('change', (e) => update_values_from_linear(parseVec(e.target.value)));
    input_cmyk.addEventListener('change', (e) => update_values_from_linear(cmykToLinear(parseCmyk(e.target.value))));

    preview.style.backgroundColor = update_values_from_linear(parseHex(input_hex_linear.value));
</script>

</html>