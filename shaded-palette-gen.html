<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./css/fonts.css">
    <link rel="stylesheet" href="./style-editor-simple.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Shaded Palette Generator">
    <title>Shaded Palette Generator</title>
</head>

<body>
    <div class="container">
        <h1>Shaded Palette Generator</h1>
        <label>
            Base Color (sRGB):
            <div class="group">
                <input id="base_color" type="color" value="#a46060" autocomplete="off">
                <input id="base_text" type="text" value="#a46060" maxlentgh="7" size="8" spellcheck="false"
                    autocomplete="off">
            </div>
        </label>
        <label>
            Light Color (sRGB):
            <div class="group">
                <input id="light_color" type="color" value="#ffffff" autocomplete="off">
                <input id="light_text" type="text" value="#ffffff" maxlentgh="7" size="8" spellcheck="false"
                    autocomplete="off">
            </div>
        </label>
        <label>
            Ambient Light Color (sRGB):
            <div class="group">
                <input id="ambient_color" type="color" value="#808080" autocomplete="off">
                <input id="ambient_text" type="text" value="#808080" maxlentgh="7" size="8" spellcheck="false"
                    autocomplete="off">
            </div>
        </label>
        <label>Specular mix:
            <div class="group">
                <input id="t_slider" type="range" min="0.0" max="1.0" value="0.25" step=0.01 autocomplete="off">
                <input id="t_number" type="number" min="0.0" max="1.0" value="0.25" size="5" step=0.01
                    autocomplete="off">
                <button id="t_reset" class="icon-button">âŸ²</button>
            </div>
        </label>
        <label>Palette Size:
            <input id="n_bands" type="number" min="2" max="256" value="5" size="3" autocomplete="off">
        </label>
        <hr>
        Palette (sRGB):
        <div id="output">
        </div>
    </div>
</body>
<script>
    const lerp_scalar = (a, b, t) => a * (1.0 - t) + b * t;

    const lerp = (a, b, t) => {
        return a.map((x, i) => {
            return lerp_scalar(x, b[i], t);
        });
    }

    function clamp(x, lower, upper) {
        return Math.min(Math.max(x, lower), upper);
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
    }

    const srgbToLinear = (srgb) => {
        return srgb.map((x) => {
            const cutoff = x > 0.04045;
            const a = x / 12.92;
            const b = ((x + 0.055) / 1.055) ** 2.4;
            return cutoff ? b : a;
        });
    }

    const linearToSrgb = (linear) => {
        return linear.map((x) => {
            const cutoff = x > 0.0031308;
            const a = x * 12.92;
            const b = 1.055 * x ** (1.0 / 2.4) - 0.055;
            return cutoff ? b : a;
        });
    }

    srgbToOklab = (c) => linearToOklab(srgbToLinear(c));

    oklabToSrgb = (c) => linearToSrgb(oklabToLinear(c));

    const parseHex = (hex) => {
        const r = parseFloat(parseInt(hex.slice(1, 3), 16)) / 255.0;
        const g = parseFloat(parseInt(hex.slice(3, 5), 16)) / 255.0;
        const b = parseFloat(parseInt(hex.slice(5, 7), 16)) / 255.0;
        return [r, g, b];
    }

    const diffuseReflection = (diffuse, light_color, ambient_light_color, t) => {
        // TODO: fresnel, riughness, ... whiten highlights
        // https://alextardif.com/PhysicallyBasedRendering.html
        // https://reference.wolfram.com/language/tutorial/PhysicallyBasedRendering.html
        return [0, 1, 2].map((index) => {
            return lerp_scalar(ambient_light_color[index], light_color[index], Math.cos(t * Math.PI / 2.0)) * diffuse[index];
        });
    }

    const writeHex = (rgb) => {
        const [r, g, b] = rgb;
        const r_u = clamp(Math.round(r * 255.0), 0, 255);
        const g_u = clamp(Math.round(g * 255.0), 0, 255);
        const b_u = clamp(Math.round(b * 255.0), 0, 255);
        return "#" + (1 << 24 | r_u << 16 | g_u << 8 | b_u).toString(16).slice(1);
    }

    const updateOutput = () => {
        const base_linear = srgbToLinear(parseHex(base_text.value));
        const light_linear = srgbToLinear(parseHex(light_text.value));
        const ambient_linear = srgbToLinear(parseHex(ambient_text.value));

        const palette_count = Number(n_bands.value);
        const specular = Number(t_slider.value);

        output.replaceChildren();
        for (let i = 0; i < palette_count; i++) {
            const t = (i / (palette_count - 1.0));
            const cos_theta = Math.cos((1.0 - t) * Math.PI / 2.0);

            let diffuse_color_linear = diffuseReflection(base_linear, light_linear, ambient_linear, t)

            // Schlick's approximation
            let specular_exponent = 2;
            let fresnel_factor = lerp_scalar(0.0, 1.0, Math.pow(1.0 - cos_theta, specular_exponent)) * specular

            let color_linear = lerp(diffuse_color_linear, light_linear, fresnel_factor)

            const hex_rgb = writeHex(linearToSrgb(color_linear))

            output.insertAdjacentHTML("beforeend",
                `
                <div class="palette-group">
                    <div class="color-preview" style="background: ${hex_rgb}"></div>
                    <input type="text" value="${hex_rgb}" maxlentgh="7" size="8" spellcheck="false" autocomplete="off">
                    <button onclick="copyToClipboard('${hex_rgb}')" class="icon-button">ðŸ“‹</button>
                </div>
                `)
        }

        let url = new URL(window.location.href);

        const params = new URLSearchParams();
        params.append("base", base_color.value);
        params.append("ambient", ambient_color.value);
        params.append("light", light_color.value);
        params.append("specular", t_number.value);
        params.append("bands", n_bands.value);

        window.history.replaceState({}, "", "?" + params.toString());
    }

    const base_text = document.querySelector('#base_text');
    const base_color = document.querySelector('#base_color');
    const ambient_text = document.querySelector('#ambient_text');
    const ambient_color = document.querySelector('#ambient_color');
    const light_text = document.querySelector('#light_text');
    const light_color = document.querySelector('#light_color');

    const output = document.querySelector('#output');
    const n_bands = document.querySelector('#n_bands');
    const t_slider = document.querySelector('#t_slider');
    const t_number = document.querySelector('#t_number');
    const t_reset = document.querySelector('#t_reset');

    // read url params
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);

    const bc = params.get("base"); // is the string "Jonathan"
    if (bc !== null) {
        base_text.value = decodeURIComponent(bc);
        base_color.value = decodeURIComponent(bc);
    }

    const ac = params.get("ambient"); // is the string "Jonathan"
    if (ac !== null) {
        ambient_text.value = decodeURIComponent(ac);
        ambient_color.value = decodeURIComponent(ac);
    }

    const light = params.get("light"); // is the string "Jonathan"
    if (ac !== null) {
        light_text.value = decodeURIComponent(light);
        light_color.value = decodeURIComponent(light);
    }

    const specular = params.get("specular"); // is the string "Jonathan"
    if (ac !== null) {
        t_slider.value = Number(specular);
        t_number.value = Number(specular);
    }

    const bands = params.get("bands"); // is the string "Jonathan"
    if (ac !== null) {
        n_bands.value = Number(bands);
    }

    base_text.addEventListener('change', (e) => { base_color.value = e.target.value; updateOutput(); });
    base_color.addEventListener('change', (e) => { base_text.value = e.target.value; updateOutput(); });
    light_text.addEventListener('change', (e) => { light_color.value = e.target.value; updateOutput(); });
    light_color.addEventListener('change', (e) => { light_text.value = e.target.value; updateOutput(); });
    ambient_text.addEventListener('change', (e) => { ambient_color.value = e.target.value; updateOutput(); });
    ambient_color.addEventListener('change', (e) => { ambient_text.value = e.target.value; updateOutput(); });

    n_bands.addEventListener('change', (e) => updateOutput());
    t_slider.addEventListener('input', (e) => { t_number.value = e.target.value; updateOutput() });
    t_number.addEventListener('change', (e) => { t_slider.value = e.target.value; updateOutput() });
    t_reset.addEventListener('click', (e) => { t_slider.value = 0.0; t_number.value = 0.0; updateOutput() });

    updateOutput();
</script>

</html>