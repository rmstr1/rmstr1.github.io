<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./shitster.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="shitster">
    <title>shitster</title>
</head>

<body>
    <div class="container">
        <div class="card" id="card">
            <div class="front" id="front">
                ðŸ’© click to solve ðŸŽµ
            </div>
            <div class="back" id="back">
                <div class="artist">
                    <h2>Artist</h2>
                    <span id="artist">At</span>
                </div>
                <div class="title">
                    <h2>Title</h2>
                    <span id="title">asdasdw qqwe qwe 12 </span>
                </div>
                <div class="release-date">
                    <h2>Release Date</h2>
                    <span id="release-date">12-12-2999</span>
                </div>
            </div>
        </div>
        <button id="next-button" disabled>Next ðŸ¡†</button>
    </div>
    <script type="module">
        async function redirectToAuthCodeFlow(clientId) {
            const verifier = generateCodeVerifier(128);
            const challenge = await generateCodeChallenge(verifier);

            localStorage.setItem("verifier", verifier);

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("response_type", "code");
            params.append("redirect_uri", auth_redirect_uri);
            params.append("scope", "user-read-private");
            params.append("code_challenge_method", "S256");
            params.append("code_challenge", challenge);

            document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function getAccessToken(clientId, code) {
            const verifier = localStorage.getItem("verifier");

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("grant_type", "authorization_code");
            params.append("code", code);
            params.append("redirect_uri", auth_redirect_uri);
            params.append("code_verifier", verifier);

            const result = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params
            });

            const { access_token } = await result.json();
            return access_token;
        }

        function generateCodeVerifier(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function getToken() {
            const encoder = new TextEncoder('utf8');
            const auth_bytes = encoder.encode(client_id + ':' + client_secret);

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                body: new URLSearchParams({
                    'grant_type': 'client_credentials',
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + auth_bytes.toBase64(),
                },
            });

            return await response.json();
        }

        //
        const clientId = '11deeddd5fbf4c27b4c13accac2906a6';
        const auth_redirect_uri = "http://127.0.0.1:8080/shitster";
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        /*if (!code) {
            redirectToAuthCodeFlow(clientId);
        } else {
            const accessToken = await getAccessToken(clientId, code);
            const profile = await fetchProfile(accessToken);
            console.log(profile);
        }

        async function fetchProfile(code) {
            const result = await fetch("https://api.spotify.com/v1/me", {
                method: "GET", headers: { Authorization: `Bearer ${code}` }
            });

            return await result.json();
        }*/

        const card = document.querySelector('#card');
        const nextBtn = document.querySelector('#next-button');

        const showCard = event => {
            event.currentTarget.setAttribute("flipped", true)
            nextBtn.disabled = false;
        };

        const nextSong = event => {
            event.currentTarget.disabled = true;
            card.setAttribute("flipped", false)
        };

        card.addEventListener("click", showCard)
        nextBtn.addEventListener("click", nextSong)
    </script>
</body>

</html>