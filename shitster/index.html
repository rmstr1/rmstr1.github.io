<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./shitster.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="shitster">
    <title>shitster</title>
</head>

<body>
    <div class="container">
        <div class="card" id="card">
            <div class="front" id="front">
                ðŸ’© click to solve ðŸŽµ
            </div>
            <div class="back" id="back">
                <div class="artist">
                    <h2>Artist</h2>
                    <span id="artist">At</span>
                </div>
                <div class="title">
                    <h2>Title</h2>
                    <span id="title">asdasdw qqwe qwe 12 </span>
                </div>
                <div class="release-date">
                    <h2>Release Date</h2>
                    <span id="release-date">12-12-2999</span>
                </div>
            </div>
        </div>
        <dialog open>
            <form method="dialog">
                Paste a playlist link here
                <input type=text></input>
                <button id="start">Start</button>
            </form>
        </dialog>
        <button id="next-button" disabled>Next ðŸ¡†</button>
    </div>
    <script type="module">
        async function redirectToAuthCodeFlow(clientId) {
            const verifier = generateCodeVerifier(128);
            const challenge = await generateCodeChallenge(verifier);

            localStorage.setItem("verifier", verifier);

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("response_type", "code");
            params.append("redirect_uri", auth_redirect_uri);
            params.append("scope", "user-read-currently-playing user-read-playback-state user-modify-playback-state");
            params.append("code_challenge_method", "S256");
            params.append("code_challenge", challenge);

            document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function getAccessToken(clientId, code) {
            const verifier = localStorage.getItem("verifier");

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("grant_type", "authorization_code");
            params.append("code", code);
            params.append("redirect_uri", auth_redirect_uri);
            params.append("code_verifier", verifier);

            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params
            });

            const { access_token } = await response.json();
            return access_token;
        }

        function generateCodeVerifier(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function getToken() {
            const encoder = new TextEncoder('utf8');
            const auth_bytes = encoder.encode(client_id + ':' + client_secret);

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                body: new URLSearchParams({
                    'grant_type': 'client_credentials',
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + auth_bytes.toBase64(),
                },
            });

            return await response.json();
        }

        async function getPlaylist(playlistId, token) {
            const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}`, {
                method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
            });

            return await response.json();
        }

        async function getDevice(token) {
            const response = await fetch('https://api.spotify.com/v1/me/player/devices', {
                method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            console.log(result)
            const active = result.devices.filter((device) => device.is_active == true);
            if (active.length > 0) {
                return active[0];
            } else if (result.devices.length > 0) {
                return result.devices[0];
            } else {
                return null;
            }
        }

        async function getTrack(playlistId, position, token) {
        }

        async function wakeUp(deviceId, token) {
            const data = JSON.stringify({
                "device_ids": [deviceId]
            })

            const response = await fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: data
            });
        }

        async function playSong(playlistId, position, token) {
            const data = JSON.stringify({
                //"context_uri": "spotify:album:5ht7ItJgpBH7W6vJ5BqpPr",
                "context_uri": `spotify:playlist:${playlistId}`,
                "offset": {
                    "position": position
                },
                "position_ms": 0
            })

            const response = await fetch('https://api.spotify.com/v1/me/player/play', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: data
            });
        }

        async function setRepeat(token) {
            const response = await fetch('https://api.spotify.com/v1/me/player/repeat?state=track', {
                method: 'PUT', headers: { 'Authorization': `Bearer ${token}` }
            });

            return await response;
        }


        async function getCurrentSong(token) {
            const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing ', {
                method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
            });

            return await response.json();
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i >= 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        const clientId = '11deeddd5fbf4c27b4c13accac2906a6';
        const auth_redirect_uri = "http://127.0.0.1:8080/shitster";
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        const shareLink = "https://open.spotify.com/playlist/2WQxrq5bmHMlVuzvtwwywV?si=0a15f640c66545e5";
        const playlistId = "2WQxrq5bmHMlVuzvtwwywV";

        if (!code) {
            redirectToAuthCodeFlow(clientId);
        } else {
            const accessToken = await getAccessToken(clientId, code);

            const device = await getDevice(accessToken);
            // TODO: no device found error
            console.log(device);

            const playlist = await getPlaylist(playlistId, accessToken);
            const trackCount = Number(playlist.tracks.total);

            let offsets = Array.from({ length: trackCount }, (_, index) => index + 1);
            shuffleArray(offsets);

            const card = document.querySelector('#card');
            const nextBtn = document.querySelector('#next-button');
            const artist = document.querySelector('#artist');
            const title = document.querySelector('#title');
            const release_date = document.querySelector('#release-date');

            let position = 0;
            await wakeUp(device.id, accessToken);
            await playSong(playlistId, offsets[position], accessToken);
            await setRepeat(accessToken);

            const showCard = async () => {
                const response = await getCurrentSong(accessToken);
                const track = response.item;
                console.log(track);
                artist.innerHTML = track.artists.map((artist) => artist.name).join(', ');
                title.innerHTML = track.name;
                release_date.innerHTML = track.album.release_date;

                card.setAttribute("flipped", true)
                if (position < offsets.length - 1) {
                    nextBtn.disabled = false;
                }
            };

            const nextSong = async () => {
                position += 1;
                nextBtn.disabled = true;
                card.setAttribute("flipped", false)
                await wakeUp(device.id, accessToken);
                await playSong(playlistId, offsets[position], accessToken);
                await setRepeat(accessToken);
            };

            card.addEventListener("click", showCard)
            nextBtn.addEventListener("click", nextSong)
        }
    </script>
</body>

</html>